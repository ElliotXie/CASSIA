---
title: "R Notebook"
output: html_notebook
---

#sctype

```{r}
#因为cellgpt annotate的顺序不太一样，所以这里先按照tissue重新排序一下，这样就可以和sctype结果直接对上

combined_csv=read.csv("C:/Users/ellio/OneDrive - UW-Madison/cellgpt_final_folder/Test_results/Elliot/GTEX/final_testing/combined_results.csv")

# Reorder rows within each tissue type
reordered_csv <- combined_csv %>%
  arrange(`tissue`, True.Cell.Type)

# If you want to save the results
write.csv(reordered_csv, "reordered_combined_results.csv", row.names = FALSE)
getwd()
```





```{r}
#跑sctype的function，需要把celltype column改成叫celltype，然后要选好tissue

perform_sctype_analysis <- function(lung, tissue) {
  # Check Seurat package version
  seurat_package_v5 <- isFALSE('counts' %in% names(attributes(lung[["RNA"]])))

  # DB file
  db_ <- "https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/ScTypeDB_full.xlsx"

  # Prepare gene sets
  gs_list <- gene_sets_prepare(db_, tissue)

  # Normalize data
  lung <- NormalizeData(lung, normalization.method = "LogNormalize", scale.factor = 10000)
  lung <- FindVariableFeatures(lung, selection.method = "vst", nfeatures = 2000)

  # Scale data and run PCA
  lung <- ScaleData(lung, features = rownames(lung))

  # Extract scaled scRNA-seq matrix
  scRNAseqData_scaled <- if (seurat_package_v5) as.matrix(lung[["RNA"]]$scale.data) else as.matrix(lung[["RNA"]]@scale.data)

  # Run ScType
  es.max <- sctype_score(scRNAseqData = scRNAseqData_scaled, scaled = TRUE, 
                         gs = gs_list$gs_positive, gs2 = gs_list$gs_negative)

  # Merge by cluster
  cL_resutls <- do.call("rbind", lapply(unique(lung@meta.data$celltype), function(cl){
    es.max.cl = sort(rowSums(es.max[ ,rownames(lung@meta.data[lung@meta.data$celltype==cl, ])]), decreasing = !0)
    head(data.frame(cluster = cl, type = names(es.max.cl), scores = es.max.cl, ncells = sum(lung@meta.data$celltype==cl)), 10)
  }))

  sctype_scores <- cL_resutls %>% group_by(cluster) %>% top_n(n = 1, wt = scores)

  # Set low-confident (low ScType score) clusters to "unknown"
  sctype_scores$type[as.numeric(as.character(sctype_scores$scores)) < sctype_scores$ncells/4] <- "Unknown"

  lung@meta.data$sctype_classification <- ""
  for(j in unique(sctype_scores$cluster)){
    cl_type = sctype_scores[sctype_scores$cluster==j,]
    lung@meta.data$sctype_classification[lung@meta.data$celltype == j] = as.character(cl_type$type[1])
  }

  return(lung)
}
```




```{r}

#sctype也是按clusterannottae的，这个function稍微转化一下cluster

compare_celltypes <- function(seurat_object, base_output_file = "celltype_comparison") {
  # Get the name of the Seurat object
  seurat_name <- deparse(substitute(seurat_object))
  
  # Create comparison dataframe
  comparison_df <- data.frame(
    Cluster = seurat_object$celltype,
    Original_Celltype = seurat_object$celltype,
    Sctype_Classification = seurat_object$sctype_classification
  )
  
  # Create summary dataframe
  summary_df <- comparison_df %>%
    group_by(Cluster, Original_Celltype, Sctype_Classification) %>%
    summarise(Count = n(), .groups = 'drop') %>%
    arrange(Cluster)
  
  # Display the summary
  print(summary_df)
  
  # Create output file name with Seurat object name
  output_file <- paste0(base_output_file, "_", seurat_name, ".csv")
  
  # Save the results
  write.csv(summary_df, output_file, row.names = FALSE)
  cat("Results saved to", output_file, "\n")
  
  # Return the summary dataframe
  return(summary_df)
}
```




```{r}
#几个例子，跑完后直接把summery_df复制到汇总的表格里就可以了
skeletalmuscle=subset(gtex,tissue=="skeletalmuscle")
skeletalmuscle <- perform_sctype_analysis(skeletalmuscle, "Muscle")
summary_df <- compare_celltypes(skeletalmuscle,base_output_file = "comparedsctype")
```



