---
title: "CASSIA: Quick Start Guide"
author:
  - name: Elliot Yixuan Xie
    affiliation: University of Wisconsin-Madison
    email: xie227@wisc.edu
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{CASSIA: Quick Start Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

CASSIA (Collaborative Agent System for Single-cell Interpretable Annotation) is
a multi-agent LLM framework for automated, reference-free cell type annotation
in single-cell RNA-seq data.

## Key Features

- **Reference-free annotation**: No pre-trained reference datasets required
- **Multi-agent system**: Specialized agents for annotation, validation, and scoring
- **Interpretable results**: Detailed reasoning for each cell type assignment
- **Multiple LLM support**: Works with Anthropic, OpenAI, and OpenRouter providers

## Citation

If you use CASSIA in your research, please cite:

> Xie, E., Cheng, L., Shireman, J. et al. CASSIA: a multi-agent large language
> model for automated and interpretable cell annotation. *Nat Commun* (2025).
> https://doi.org/10.1038/s41467-025-67084-x

## Full Documentation

For comprehensive tutorials, advanced features, and detailed examples, visit:
**[https://docs.cassia.bio](https://docs.cassia.bio)**

# Installation

## From GitHub

```{r install-github, eval=FALSE}
if (!requireNamespace("devtools", quietly = TRUE)) {
    install.packages("devtools")
}
devtools::install_github("ElliotXie/CASSIA", subdir = "CASSIA_R")
```

## Python Environment Setup

CASSIA requires a Python backend. Set up the environment automatically:
```{r setup-env, eval=FALSE}
library(CASSIA)
setup_cassia_env()
```

This creates a conda environment with all required Python dependencies.

# Configuration

## API Key Setup

CASSIA uses large language models via API. Set your API key for your preferred
provider:

```{r api-keys, eval=FALSE}
# For Anthropic (Claude models)
setLLMApiKey("your-api-key", provider = "anthropic")

# For OpenAI (GPT models)
setLLMApiKey("your-api-key", provider = "openai")

# For OpenRouter (multiple models - recommended)
setLLMApiKey("your-api-key", provider = "openrouter")
```

## Validate Configuration

Check that your environment is properly configured:

```{r validate, eval=FALSE}
check_python_env()
validate_api_keys()
```

# Single Cluster Annotation

Use `runCASSIA()` to annotate a single cluster based on marker genes:

```{r single-annotation, eval=FALSE}
library(CASSIA)

# Annotate a single cluster with marker genes
result <- runCASSIA(
  marker_list = c("CD3D", "CD3E", "CD4", "IL7R"),
  tissue = "PBMC",
  species = "human",
  provider = "openrouter",
  model = "anthropic/claude-sonnet-4.5"
)

# View the annotation result
result$structured_output
```

**Example output structure:**

```
$cell_type
[1] "CD4+ T cells"

$confidence
[1] "high"

$reasoning
[1] "The marker genes CD3D and CD3E indicate T cell lineage. CD4 expression
     combined with IL7R suggests naive or memory CD4+ T helper cells..."
```

## Parameters

- `marker_list`: Character vector of marker genes, comma-separated string, or
  data frame with a 'gene' column
- `tissue`: Tissue type (e.g., "PBMC", "brain", "liver")
- `species`: Species (e.g., "human", "mouse")
- `provider`: LLM provider ("openrouter", "anthropic", or "openai")
- `model`: Model name to use for annotation

# Batch Annotation

Use `runCASSIA_batch()` to annotate multiple clusters efficiently:

```{r batch-annotation, eval=FALSE}
# Load marker data with multiple clusters
# Expected format: data frame with 'cluster' and 'gene' columns
markers <- loadExampleMarkers()

# Run batch annotation
results <- runCASSIA_batch(
  marker_data = markers,
  tissue = "PBMC",
  species = "human",
  provider = "openrouter",
  model = "anthropic/claude-sonnet-4.5",
  max_workers = 4
)

# Results are returned as a list, one entry per cluster
names(results)
```

## Input Format

The `marker_data` should be a data frame with at minimum:

- `cluster`: Cluster identifier
- `gene`: Marker gene name

Additional columns like `avg_log2FC` or `p_val_adj` can be included for ranking.

# Seurat Integration

CASSIA integrates directly with Seurat objects:

```{r seurat, eval=FALSE}
library(Seurat)

# After running FindAllMarkers on your Seurat object
markers <- FindAllMarkers(seurat_obj)

# Run CASSIA batch annotation
results <- runCASSIA_batch(
  marker_data = markers,
  tissue = "brain",
  species = "mouse"
)

# Add annotations back to Seurat object
seurat_obj <- add_cassia_to_seurat(seurat_obj, results)
```


# Advanced Features

For advanced features including:

- **Annotation Boosting**: Iterative refinement for low-confidence annotations
- **Subclustering Analysis**: Detailed heterogeneity analysis within clusters
- **Uncertainty Quantification**: Multiple annotation runs to assess confidence
- **Complete Pipeline**: End-to-end annotation with scoring and reporting

Please visit our comprehensive documentation at:
**[https://docs.cassia.bio](https://docs.cassia.bio)**

# Session Information

```{r session-info}
sessionInfo()
```
