---
title: "CASSIA: Quick Start Guide"
author:
  - name: Elliot Yixuan Xie
    affiliation: University of Wisconsin-Madison
    email: xie227@wisc.edu
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{CASSIA: Quick Start Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

# Introduction

CASSIA (Collaborative Agent System for Single-cell Interpretable Annotation) is
a multi-agent LLM framework for automated, reference-free cell type annotation
in single-cell RNA-seq data.

## Key Features

- **Reference-free annotation**: No pre-trained reference datasets required
- **Multi-agent system**: Specialized agents for annotation, validation, scoring
- **Interpretable results**: Detailed reasoning for each cell type assignment
- **Multiple LLM support**: Works with Anthropic, OpenAI, and OpenRouter providers
- **Batch processing**: Efficiently annotate multiple clusters in parallel

## Citation

If you use CASSIA in your research, please cite:

> Xie, E.Y. et al. (2024). CASSIA: A Collaborative Agent System for Single-cell
> Interpretable Annotation. *Nature Communications*.

# Installation

## From GitHub

```{r install-github}
if (!requireNamespace("devtools", quietly = TRUE)) {
    install.packages("devtools")
}
devtools::install_github("ElliotXie/CASSIA", subdir = "CASSIA_R")
```

## Python Environment Setup

CASSIA requires a Python backend. Set up the environment automatically:

```{r setup-env}
library(CASSIA)
setup_cassia_env()
```

This creates a conda environment with all required Python dependencies.

# Configuration

## API Key Setup

CASSIA uses large language models via API. Set your API key for your preferred
provider:

```{r api-keys}
# For Anthropic (Claude models)
setLLMApiKey("your-api-key", provider = "anthropic")

# For OpenAI (GPT models)
setLLMApiKey("your-api-key", provider = "openai")

# For OpenRouter (multiple models)
setLLMApiKey("your-api-key", provider = "openrouter")
```

## Validate Configuration

Check that your environment is properly configured:

```{r validate}
check_python_env()
validate_api_keys()
```

# Quick Start

## Load Example Data

CASSIA includes example marker gene data for testing:

```{r load-example, eval=TRUE}
library(CASSIA)

# Check available example datasets
listAvailableMarkers()
```

```{r load-markers}
# Load example PBMC markers
markers <- loadExampleMarkers()
head(markers)
```

## Single Cluster Annotation

Annotate a single cluster using marker genes:

```{r single-annotation}
result <- runCASSIA(
  marker_list = c("CD3D", "CD3E", "CD4", "IL7R"),
  tissue = "PBMC",
  species = "human",
  provider = "openrouter",
  model = "google/gemini-2.5-flash-preview"
)

# View the annotation
result$structured_output
```

**Expected output structure:**

```
$cell_type
[1] "CD4+ T cells"

$confidence
[1] "high"

$reasoning
[1] "The marker genes CD3D, CD3E indicate T cell lineage. CD4 expression
     combined with IL7R suggests naive or memory CD4+ T helper cells..."
```

## Batch Annotation

For multiple clusters, use batch processing:

```{r batch-annotation}
# Load marker data with multiple clusters
markers <- loadExampleMarkers()

# Run batch annotation
results <- runCASSIA_batch(
  marker_data = markers,
  tissue = "PBMC",
  species = "human",
  provider = "openrouter",
  model = "google/gemini-2.5-flash-preview",
  max_workers = 4
)

# Results are returned as a list, one entry per cluster
names(results)
```

# Complete Pipeline

For comprehensive analysis with quality scoring and iterative refinement:

```{r pipeline}
runCASSIA_pipeline(
  output_file_name = "my_analysis",
  tissue = "PBMC",
  species = "human",
  marker = markers,
  max_workers = 4,
  score_threshold = 75,  # Re-annotate clusters scoring below 75
  do_merge_annotations = TRUE,
  output_dir = "results/"
)
```

This generates:

- Annotation results for each cluster
- Quality scores with detailed evaluation
- HTML reports with visualizations
- Merged consensus annotations

# Advanced Features

## Annotation Boosting

For low-confidence annotations, iteratively refine with additional analysis:

```{r boost}
boosted <- runCASSIA_annotationboost(
  marker_list = markers,
  tissue = "PBMC",
  species = "human",
  initial_annotation = "T cells",
  search_strategy = "breadth"
)
```

## Subclustering Analysis

Analyze heterogeneity within clusters:

```{r subcluster}
subcluster_results <- runCASSIA_subclusters(
  marker_data = markers,
  tissue = "PBMC",
  species = "human",
  parent_cluster = "T cells"
)
```

## Uncertainty Quantification

Run multiple annotation attempts to assess confidence:

```{r uncertainty}
uncertainty <- runCASSIA_n_times(
  marker_list = markers,
  tissue = "PBMC",
  species = "human",
  n = 5
)

# Get similarity scores across runs
uncertainty$similarity_scores
```

# Seurat Integration

CASSIA integrates directly with Seurat objects:

```{r seurat}
library(Seurat)

# After running FindAllMarkers
markers <- FindAllMarkers(seurat_obj)

# Run CASSIA pipeline
results <- runCASSIA_batch(
  marker_data = markers,
  tissue = "brain",
  species = "mouse"
)

# Add annotations to Seurat object
seurat_obj <- add_cassia_to_seurat(seurat_obj, results)
```

# Model Selection

CASSIA supports multiple LLM providers and models:

```{r models, eval=TRUE}
# List available models
list_models()
```

```{r recommended}
# Get recommended model for your use case
get_recommended_model(use_case = "annotation")
```

Different models offer trade-offs between cost, speed, and accuracy. For most
use cases, we recommend starting with `google/gemini-2.5-flash-preview` via
OpenRouter for its balance of performance and cost.

# Troubleshooting

## Common Issues

**Python environment not found:**
```{r troubleshoot-python}
# Reinstall the environment
setup_cassia_env(force = TRUE)
```

**API key errors:**
```{r troubleshoot-api}
# Verify keys are set correctly
validate_api_keys()
```

**Rate limiting:**
Reduce `max_workers` in batch processing to avoid API rate limits.

# Session Information

```{r session-info, eval=TRUE}
sessionInfo()
```

# References

1. Xie, E.Y. et al. (2024). CASSIA: A Collaborative Agent System for Single-cell
   Interpretable Annotation. *Nature Communications*.
