<!DOCTYPE html>
<html>
<head>
    <title>Test Batch CSV Downloads</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .button { background: #10b981; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        .result { background: #f3f4f6; padding: 15px; margin: 10px 0; border-radius: 5px; }
        pre { background: #1f2937; color: #f9fafb; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test CASSIA Batch CSV Downloads</h1>
    
    <div>
        <button class="button" onclick="testSummaryCSV()">Download Summary CSV</button>
        <button class="button" onclick="testFullCSV()">Download Full CSV</button>
        <button class="button" onclick="testBothCSV()">Download Both CSV Files</button>
    </div>
    
    <div id="result" class="result">
        <p>Click buttons above to test CSV downloads. Results will appear here.</p>
    </div>

    <script>
        // Mock batch results data
        const mockResults = {
            total_clusters: 5,
            successful_analyses: 4,
            failed_analyses: 1,
            output_files: ['batch_analysis_full.csv', 'batch_analysis_summary.csv'],
            results: {}
        };

        function downloadFile(data, filename, mimeType) {
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateBatchSummaryCSV(results) {
            const headers = [
                'True Cell Type', 'Predicted Main Cell Type', 'Predicted Sub Cell Types',
                'Possible Mixed Cell Types', 'Marker List', 'Iterations', 'Model', 'Provider',
                'Tissue', 'Species'
            ];
            
            const rows = [];
            for (let i = 0; i < (results.total_clusters || 3); i++) {
                const cellTypes = ['T cells', 'B cells', 'Macrophages', 'NK cells', 'Monocytes'];
                const failed = i >= (results.successful_analyses || 0);
                
                rows.push([
                    `Cluster_${i}`,
                    failed ? 'Failed Analysis' : cellTypes[i % cellTypes.length],
                    failed ? '' : 'Memory T cells, Naive T cells',
                    failed ? '' : 'CD4+ T cells',
                    failed ? '' : 'CD3D, CD3E, CD4',
                    failed ? '0' : '1',
                    'google/gemini-2.5-flash-preview',
                    'openrouter',
                    'peripheral_blood',
                    'human'
                ].join(','));
            }
            
            return headers.join(',') + '\n' + rows.join('\n');
        }

        function generateBatchFullCSV(results) {
            const headers = [
                'True Cell Type', 'Predicted Main Cell Type', 'Predicted Sub Cell Types',
                'Possible Mixed Cell Types', 'Marker Number', 'Marker List', 'Iterations',
                'Model', 'Provider', 'Tissue', 'Species', 'Additional Info', 'Conversation History'
            ];
            
            const rows = [];
            for (let i = 0; i < (results.total_clusters || 3); i++) {
                const cellTypes = ['T cells', 'B cells', 'Macrophages', 'NK cells', 'Monocytes'];
                const failed = i >= (results.successful_analyses || 0);
                
                rows.push([
                    `Cluster_${i}`,
                    failed ? 'Failed Analysis' : cellTypes[i % cellTypes.length],
                    failed ? '' : 'Memory T cells, Naive T cells',
                    failed ? '' : 'CD4+ T cells', 
                    failed ? '0' : '3',
                    failed ? '' : 'CD3D, CD3E, CD4',
                    failed ? '0' : '1',
                    'google/gemini-2.5-flash-preview',
                    'openrouter',
                    'peripheral_blood',
                    'human',
                    '',
                    failed ? 'Analysis failed due to API error' : 'Human: Analyze these markers... | Assistant: Based on the markers...'
                ].map(field => `"${field}"`).join(','));
            }
            
            return headers.join(',') + '\n' + rows.join('\n');
        }

        function testSummaryCSV() {
            const data = generateBatchSummaryCSV(mockResults);
            downloadFile(data, 'batch_summary_test.csv', 'text/csv');
            
            document.getElementById('result').innerHTML = `
                <h3>âœ… Summary CSV Generated</h3>
                <p><strong>Filename:</strong> batch_summary_test.csv</p>
                <p><strong>Size:</strong> ${data.length} characters</p>
                <p><strong>Rows:</strong> ${mockResults.total_clusters + 1} (including header)</p>
                <pre>${data.substring(0, 300)}${data.length > 300 ? '...' : ''}</pre>
            `;
        }

        function testFullCSV() {
            const data = generateBatchFullCSV(mockResults);
            downloadFile(data, 'batch_full_test.csv', 'text/csv');
            
            document.getElementById('result').innerHTML = `
                <h3>âœ… Full CSV Generated</h3>
                <p><strong>Filename:</strong> batch_full_test.csv</p>
                <p><strong>Size:</strong> ${data.length} characters</p>
                <p><strong>Rows:</strong> ${mockResults.total_clusters + 1} (including header)</p>
                <p><strong>Includes:</strong> Conversation history, marker numbers, additional context</p>
                <pre>${data.substring(0, 400)}${data.length > 400 ? '...' : ''}</pre>
            `;
        }

        function testBothCSV() {
            const summaryData = generateBatchSummaryCSV(mockResults);
            const fullData = generateBatchFullCSV(mockResults);
            
            downloadFile(summaryData, 'batch_summary_test.csv', 'text/csv');
            setTimeout(() => {
                downloadFile(fullData, 'batch_full_test.csv', 'text/csv');
            }, 100);
            
            document.getElementById('result').innerHTML = `
                <h3>âœ… Both CSV Files Generated</h3>
                <p><strong>Files:</strong> batch_summary_test.csv, batch_full_test.csv</p>
                <p><strong>Summary Size:</strong> ${summaryData.length} characters</p>
                <p><strong>Full Size:</strong> ${fullData.length} characters</p>
                <p><strong>Total Clusters:</strong> ${mockResults.total_clusters}</p>
                <p><strong>Successful:</strong> ${mockResults.successful_analyses}</p>
                <p><strong>Failed:</strong> ${mockResults.failed_analyses}</p>
            `;
        }

        // Show initial state
        document.getElementById('result').innerHTML = `
            <h3>ðŸ“Š Mock Batch Results</h3>
            <pre>${JSON.stringify(mockResults, null, 2)}</pre>
            <p>Ready to test CSV downloads!</p>
        `;
    </script>
</body>
</html>